<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Servicios - Transportes Masic</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 16px;
            padding-bottom: 80px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 20px;
            color: var(--tg-theme-text-color, #000000);
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 14px;
            color: var(--tg-theme-text-color, #000000);
        }

        .required {
            color: #e74c3c;
        }

        input, select {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 1px solid var(--tg-theme-hint-color, #999999);
            border-radius: 8px;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #3390ec);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .error-message {
            background-color: #ffe6e6;
            color: #c0392b;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        /* Estilo para selects con datos cargados */
        select.loaded {
            background-color: #f0f9ff;
        }

        select.loading-data {
            background-color: #fff9e6;
        }

        select.error-data {
            background-color: #ffe6e6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìã Registro de Servicio</h1>
        
        <div id="mensajeEstado"></div>

        <form id="formularioServicio">
            <!-- Cliente -->
            <div class="form-group">
                <label for="cliente">Cliente <span class="required">*</span></label>
                <select id="cliente" name="cliente" required>
                    <option value="">Cargando clientes...</option>
                </select>
            </div>

            <!-- Veh√≠culo -->
            <div class="form-group">
                <label for="vehiculo">Veh√≠culo (Patente) <span class="required">*</span></label>
                <select id="vehiculo" name="vehiculo" required>
                    <option value="">Cargando veh√≠culos...</option>
                </select>
            </div>

            <!-- Conductor -->
            <div class="form-group">
                <label for="conductor">Conductor <span class="required">*</span></label>
                <select id="conductor" name="conductor" required>
                    <option value="">Cargando conductores...</option>
                </select>
            </div>

            <!-- Tipo de Servicio -->
            <div class="form-group">
                <label for="tipoServicio">Tipo de Servicio <span class="required">*</span></label>
                <select id="tipoServicio" name="tipoServicio" required>
                    <option value="">Cargando tipos...</option>
                </select>
            </div>

            <!-- Origen -->
            <div class="form-group">
                <label for="origen">Origen <span class="required">*</span></label>
                <input type="text" id="origen" name="origen" placeholder="Ej: Aeropuerto El Tepual" required>
            </div>

            <!-- Destino -->
            <div class="form-group">
                <label for="destino">Destino <span class="required">*</span></label>
                <input type="text" id="destino" name="destino" placeholder="Ej: Hotel Dreams" required>
            </div>

            <!-- Kil√≥metros -->
            <div class="form-group">
                <label for="km">Kil√≥metros <span class="required">*</span></label>
                <input type="number" id="km" name="km" placeholder="Ej: 25" min="0" required>
            </div>

            <!-- Pasajeros -->
            <div class="form-group">
                <label for="pasajeros">N√∫mero de Pasajeros <span class="required">*</span></label>
                <input type="number" id="pasajeros" name="pasajeros" placeholder="Ej: 4" min="1" required>
            </div>

            <!-- Monto -->
            <div class="form-group">
                <label for="monto">Monto ($) <span class="required">*</span></label>
                <input type="number" id="monto" name="monto" placeholder="Ej: 35000" min="0" required>
            </div>

            <!-- Forma de Pago -->
            <div class="form-group">
                <label for="formaPago">Forma de Pago <span class="required">*</span></label>
                <select id="formaPago" name="formaPago" required>
                    <option value="">Cargando formas de pago...</option>
                </select>
            </div>

            <!-- Bot√≥n para cuando NO est√° en Telegram -->
            <button type="button" id="btnRegistrarWeb" style="display: none; width: 100%; padding: 16px; background: #3390ec; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 20px;">
                üìù Registrar Servicio
            </button>
        </form>
    </div>

    <script>
        // =============================================
        // CONFIGURACI√ìN
        // =============================================
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzu6qesXwlj_bvFxyOXg4e33ccx5snD623oH_3krfWycw0qgyJTreDOv4OAc_bf2FT1/exec';
        
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.MainButton.setText('Registrar Servicio');
        tg.MainButton.show();

        // =============================================
        // VARIABLES GLOBALES
        // =============================================
        let datosClientes = [];
        let datosVehiculos = [];
        let datosConductores = [];
        let datosTiposServicio = [];
        let datosFormasPago = [];

        // =============================================
        // FUNCIONES PARA CARGAR DATOS
        // =============================================
        async function cargarDatosDesdeGoogleSheets(action) {
            console.log(`üîç Intentando cargar: ${action}`);
            console.log(`üì° URL del script: ${GOOGLE_SCRIPT_URL}`);
            
            try {
                // SOLUCI√ìN CORS: Usar GET en lugar de POST
                const url = `${GOOGLE_SCRIPT_URL}?action=${encodeURIComponent(action)}`;
                console.log(`üì§ URL completa:`, url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    redirect: 'follow'
                });

                console.log(`üì• Respuesta recibida. Status: ${response.status}`);
                console.log(`üì• Status text: ${response.statusText}`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
                }

                const responseText = await response.text();
                console.log(`üìÑ Respuesta (texto):`, responseText.substring(0, 200));
                
                const result = JSON.parse(responseText);
                console.log(`‚úÖ Respuesta parseada:`, result);
                
                if (!result.success) {
                    throw new Error(result.error || 'Error desconocido');
                }

                return result.data;
            } catch (error) {
                console.error(`‚ùå Error al cargar ${action}:`, error);
                console.error(`‚ùå Error completo:`, error.stack);
                throw error;
            }
        }

        function llenarSelect(selectId, datos, valorKey, textoKey, textoExtra = null) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">Selecciona una opci√≥n</option>';
            
            datos.forEach(item => {
                const option = document.createElement('option');
                option.value = item[valorKey];
                
                // Formateo especial seg√∫n el tipo de dato
                if (selectId === 'vehiculo') {
                    // Para veh√≠culos: "PATENTE - Marca Modelo"
                    option.textContent = `${item.patente} - ${item.marca} ${item.modelo}`.trim();
                } else if (selectId === 'conductor') {
                    // Para conductores: "Nombre (RUT)"
                    option.textContent = item.nombre + (item.rut ? ` (${item.rut})` : '');
                } else if (selectId === 'cliente') {
                    // Para clientes: "Nombre"
                    option.textContent = item.nombre;
                } else if (textoExtra) {
                    option.textContent = `${item[textoKey]} - ${item[textoExtra]}`;
                } else {
                    option.textContent = item[textoKey];
                }
                
                select.appendChild(option);
            });
            
            select.classList.remove('loading-data', 'error-data');
            select.classList.add('loaded');
        }

        function marcarSelectError(selectId, mensaje) {
            const select = document.getElementById(selectId);
            select.innerHTML = `<option value="">${mensaje}</option>`;
            select.classList.remove('loading-data', 'loaded');
            select.classList.add('error-data');
        }

        // =============================================
        // CARGAR TODOS LOS DATOS AL INICIAR
        // =============================================
        async function inicializarApp() {
            console.log('üöÄ Iniciando aplicaci√≥n...');
            mostrarMensaje('Cargando datos desde Google Sheets...', 'info');

            // Verificar que la URL est√© configurada
            if (GOOGLE_SCRIPT_URL === 'TU_URL_DE_GOOGLE_APPS_SCRIPT_AQUI') {
                mostrarMensaje('‚ö†Ô∏è ERROR: Debes configurar la URL de Google Apps Script', 'error');
                return;
            }

            try {
                // Cargar todos los datos en paralelo
                const [clientes, vehiculos, conductores, tiposServicio, formasPago] = await Promise.all([
                    cargarDatosDesdeGoogleSheets('obtenerClientes'),
                    cargarDatosDesdeGoogleSheets('obtenerVehiculos'),
                    cargarDatosDesdeGoogleSheets('obtenerConductores'),
                    cargarDatosDesdeGoogleSheets('obtenerTiposServicio'),
                    cargarDatosDesdeGoogleSheets('obtenerFormasPago')
                ]);

                // Guardar datos en variables globales
                datosClientes = clientes;
                datosVehiculos = vehiculos;
                datosConductores = conductores;
                datosTiposServicio = tiposServicio;
                datosFormasPago = formasPago;

                // Llenar los selects
                llenarSelect('cliente', clientes, 'nombre', 'nombre');
                llenarSelect('vehiculo', vehiculos, 'patente', 'patente');
                llenarSelect('conductor', conductores, 'nombre', 'nombre');
                llenarSelect('tipoServicio', tiposServicio, 'codigo', 'descripcion');
                llenarSelect('formaPago', formasPago, 'codigo', 'descripcion');

                mostrarMensaje(`‚úÖ Datos cargados: ${clientes.length} clientes, ${vehiculos.length} veh√≠culos, ${conductores.length} conductores`, 'success');
                
                console.log('‚úÖ Todos los datos cargados correctamente');
            } catch (error) {
                console.error('‚ùå Error al cargar datos:', error);
                mostrarMensaje('‚ùå Error al cargar datos. Verifica tu conexi√≥n e intenta nuevamente.', 'error');
                
                // Marcar todos los selects con error
                marcarSelectError('cliente', '‚ùå Error al cargar');
                marcarSelectError('vehiculo', '‚ùå Error al cargar');
                marcarSelectError('conductor', '‚ùå Error al cargar');
                marcarSelectError('tipoServicio', '‚ùå Error al cargar');
                marcarSelectError('formaPago', '‚ùå Error al cargar');
            }
        }

        // =============================================
        // FUNCIONES DE INTERFAZ
        // =============================================
        function mostrarMensaje(texto, tipo = 'info') {
            const contenedor = document.getElementById('mensajeEstado');
            
            let clase = 'loading';
            if (tipo === 'error') clase = 'error-message';
            if (tipo === 'success') clase = 'success-message';
            
            contenedor.innerHTML = `<div class="${clase}">${texto}</div>`;
            
            // Limpiar mensaje despu√©s de 5 segundos si es √©xito
            if (tipo === 'success') {
                setTimeout(() => {
                    contenedor.innerHTML = '';
                }, 5000);
            }
        }

        // =============================================
        // ENVIAR DATOS A GOOGLE SHEETS
        // =============================================
        async function enviarDatosAGoogleSheets(datos) {
            console.log('üåê Enviando a:', GOOGLE_SCRIPT_URL);
            console.log('üì¶ Datos a enviar:', JSON.stringify(datos));
            console.log('‚è≥ Enviando petici√≥n POST...');
            
            try {
                // Crear URLSearchParams para evitar CORS
                const formData = new URLSearchParams();
                formData.append('action', 'registrarServicio');
                formData.append('cliente', datos.cliente);
                formData.append('vehiculo', datos.vehiculo);
                formData.append('conductor', datos.conductor);
                formData.append('tipoServicio', datos.tipoServicio);
                formData.append('origen', datos.origen);
                formData.append('destino', datos.destino);
                formData.append('km', datos.km);
                formData.append('pasajeros', datos.pasajeros);
                formData.append('monto', datos.monto);
                formData.append('formaPago', datos.formaPago);
                
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                });

                console.log('‚úÖ Respuesta recibida. Status:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const responseText = await response.text();
                console.log('üì® Respuesta (texto):', responseText);
                
                const result = JSON.parse(responseText);
                console.log('üì® Resultado parseado:', JSON.stringify(result));

                if (!result.success) {
                    throw new Error(result.error || 'Error desconocido del servidor');
                }

                return result;
            } catch (error) {
                console.error('üí• ERROR de conexi√≥n:', error);
                throw error;
            }
        }

        // =============================================
        // MANEJAR ENV√çO DEL FORMULARIO
        // =============================================
        tg.MainButton.onClick(async function() {
            const form = document.getElementById('formularioServicio');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const formData = new FormData(form);
            const datos = Object.fromEntries(formData.entries());

            console.log('üìù Formulario enviado');
            console.log('üìä Datos del formulario:', JSON.stringify(datos));

            tg.MainButton.showProgress();
            mostrarMensaje('Enviando datos...', 'info');

            try {
                const resultado = await enviarDatosAGoogleSheets(datos);
                
                if (resultado.success) {
                    console.log('‚úÖ Servicio registrado con ID:', resultado.idServicio);
                    mostrarMensaje(`‚úÖ Servicio #${resultado.idServicio} registrado exitosamente`, 'success');
                    
                    // Notificar a Telegram que todo sali√≥ bien
                    tg.showAlert('‚úÖ Servicio registrado correctamente', function() {
                        tg.close();
                    });
                } else {
                    throw new Error(resultado.error || 'Error desconocido');
                }
            } catch (error) {
                console.error('‚ùå Error:', error);
                mostrarMensaje(`‚ùå Error: ${error.message}`, 'error');
                tg.showAlert('‚ùå Error al registrar el servicio: ' + error.message);
            } finally {
                tg.MainButton.hideProgress();
            }
        });

        // =============================================
        // INICIAR LA APLICACI√ìN
        // =============================================
        window.addEventListener('DOMContentLoaded', () => {
            // Detectar si est√° en Telegram o en navegador web
            const enTelegram = window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData;
            
            if (!enTelegram) {
                // Si NO est√° en Telegram, mostrar bot√≥n web
                const btnWeb = document.getElementById('btnRegistrarWeb');
                btnWeb.style.display = 'block';
                
                // Manejar click del bot√≥n web
                btnWeb.addEventListener('click', async function() {
                    const form = document.getElementById('formularioServicio');
                    
                    if (!form.checkValidity()) {
                        form.reportValidity();
                        return;
                    }

                    const formData = new FormData(form);
                    const datos = Object.fromEntries(formData.entries());

                    console.log('üìù Formulario enviado desde WEB');
                    console.log('üìä Datos del formulario:', JSON.stringify(datos));

                    btnWeb.disabled = true;
                    btnWeb.textContent = '‚è≥ Registrando...';
                    mostrarMensaje('Enviando datos...', 'info');

                    try {
                        const resultado = await enviarDatosAGoogleSheets(datos);
                        
                        if (resultado.success) {
                            console.log('‚úÖ Servicio registrado con ID:', resultado.idServicio);
                            mostrarMensaje(`‚úÖ Servicio #${resultado.idServicio} registrado exitosamente`, 'success');
                            
                            // Limpiar formulario
                            form.reset();
                            
                            alert('‚úÖ Servicio registrado correctamente\n\nID: ' + resultado.idServicio);
                        } else {
                            throw new Error(resultado.error || 'Error desconocido');
                        }
                    } catch (error) {
                        console.error('‚ùå Error:', error);
                        mostrarMensaje(`‚ùå Error: ${error.message}`, 'error');
                        alert('‚ùå Error al registrar el servicio:\n\n' + error.message);
                    } finally {
                        btnWeb.disabled = false;
                        btnWeb.textContent = 'üìù Registrar Servicio';
                    }
                });
            }
            
            inicializarApp();
        });
        
        console.log('üöÄ App iniciada');
        console.log('üìç URL configurada:', GOOGLE_SCRIPT_URL !== 'TU_URL_DE_GOOGLE_APPS_SCRIPT_AQUI' ? 'S√ç ‚úÖ' : 'NO ‚ùå');
    </script>
</body>
</html>
